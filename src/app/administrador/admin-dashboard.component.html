<div class="admin-container">

  <!-- HEADER -->
  <header class="admin-header">
    <div class="header-content">

      <div class="brand">
        <div class="brand-icon">
        </div>
        <div>
          <h1>Panel de Administrador</h1>
          <p class="subtitle">Gestión de usuarios y permisos</p>
        </div>
      </div>

      <button (click)="cerrarSesion()" class="logout-btn">
        Cerrar Sesión
      </button>

    </div>
  </header>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="admin-content">

    <!-- TARJETAS DE ESTADÍSTICAS -->
    <div class="stats-grid">

      <div class="stat-card">
        <div class="stat-icon admin"></div>
        <div class="stat-info">
          <p class="stat-label">Administradores</p>
          <p class="stat-value">{{ (usuarios | filter:'administrador').length }}</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon programmer"></div>
        <div class="stat-info">
          <p class="stat-label">Programadores</p>
          <p class="stat-value">{{ (usuarios | filter:'programador').length }}</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon user"></div>
        <div class="stat-info">
          <p class="stat-label">Usuarios</p>
          <p class="stat-value">{{ (usuarios | filter:'usuario').length }}</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon total"></div>
        <div class="stat-info">
          <p class="stat-label">Total Usuarios</p>
          <p class="stat-value">{{ usuarios.length }}</p>
        </div>
      </div>

    </div>

    <!-- NAVEGACIÓN DE VISTAS -->
    <div class="view-tabs">
      <button 
        class="tab-btn" 
        [class.active]="vistaActiva === 'usuarios'"
        (click)="cambiarVista('usuarios')">
        Gestión de Usuarios
      </button>
      <button 
        class="tab-btn" 
        [class.active]="vistaActiva === 'historial'"
        (click)="cambiarVista('historial')">
        Dashboard de Asesorías
      </button>
      <button 
        class="tab-btn" 
        [class.active]="vistaActiva === 'proyectos'"
        (click)="cambiarVista('proyectos')">
        Dashboard de Proyectos
      </button>
    </div>

    <!-- SECCIÓN DE GRÁFICOS DE ASESORÍAS -->
    <section class="dashboard-section" *ngIf="vistaActiva === 'historial'">
      <div class="section-header">
        <h2>Dashboard de Asesorías</h2>
        <p class="subtitle">Análisis visual y estadísticas del sistema</p>
      </div>

      <!-- Mensaje cuando no hay asesorías -->
      <div *ngIf="asesorias.length === 0" class="empty-dashboard">
        <div class="empty-icon"></div>
        <h3>No hay asesorías registradas</h3>
        <p>Cuando se realicen asesorías, las estadísticas aparecerán aquí</p>
      </div>
      
      <!-- Gráficos cuando hay datos -->
      <div *ngIf="asesorias.length > 0" class="charts-grid">
        <div class="chart-card">
          <h3>Asesorías por Estado</h3>
          <div class="chart-container">
            <canvas #estadoChart></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <h3>Top 5 Programadores</h3>
          <div class="chart-container">
            <canvas #programadorChart></canvas>
          </div>
        </div>
        
        <div class="chart-card chart-wide">
          <h3>Tendencia Últimos 6 Meses</h3>
          <div class="chart-container">
            <canvas #mensualChart></canvas>
          </div>
        </div>
      </div>

      <!-- HISTORIAL DETALLADO -->
      <div class="historial-header" *ngIf="asesorias.length > 0">
        <h3>Historial Completo</h3>
        <div class="search-box">
          <input type="text" 
                 placeholder="Buscar por programador, usuario, estado..."
                 [(ngModel)]="filtroHistorial" 
                 (input)="filtrarHistorial()">
        </div>
      </div>

      <div class="historial-grid" *ngIf="asesorias.length > 0">
        <div *ngFor="let asesoria of asesoriasFiltradasHistorial" class="asesoria-item">
          <div class="asesoria-header">
            <span [class]="'estado-badge ' + obtenerEstadoClase(asesoria.estado)">
              {{ obtenerEstadoTexto(asesoria.estado) }}
            </span>
            <span class="fecha">{{ asesoria.fechaAsesoria }} - {{ asesoria.horaAsesoria }}</span>
          </div>
          
          <div class="asesoria-body">
            <div class="participantes">
              <div class="participante">
                <span class="label">Programador:</span>
                <span class="nombre">{{ obtenerNombreUsuario(asesoria.idProgramador) }}</span>
              </div>
              <div class="participante">
                <span class="label">Usuario:</span>
                <span class="nombre">{{ obtenerNombreUsuario(asesoria.idUsuario) }}</span>
              </div>
            </div>
            
            <div class="motivo" *ngIf="asesoria.motivo">
              <span class="label">Motivo:</span>
              <p>{{ asesoria.motivo }}</p>
            </div>
            
            <div class="respuesta" *ngIf="asesoria.mensajeRespuesta">
              <span class="label">Respuesta:</span>
              <p>{{ asesoria.mensajeRespuesta }}</p>
            </div>
          </div>
        </div>
        
        <div *ngIf="asesoriasFiltradasHistorial.length === 0" class="empty-historial">
          <p>No se encontraron asesorías</p>
        </div>
      </div>
    </section>

    <!-- SECCIÓN DE GRÁFICOS DE PROYECTOS -->
    <section class="dashboard-section" *ngIf="vistaActiva === 'proyectos'">
      <div class="section-header">
        <h2>Dashboard de Proyectos</h2>
        <p class="subtitle">Análisis visual y estadísticas de proyectos</p>
      </div>

      <!-- Mensaje cuando no hay proyectos -->
      <div *ngIf="proyectos.length === 0" class="empty-dashboard">
        <div class="empty-icon"></div>
        <h3>No hay proyectos registrados</h3>
        <p>Cuando se creen proyectos, las estadísticas aparecerán aquí</p>
      </div>
      
      <!-- Gráficos cuando hay datos -->
      <div *ngIf="proyectos.length > 0" class="charts-grid">
        <div class="chart-card">
          <h3>Proyectos por Tipo</h3>
          <div class="chart-container">
            <canvas #proyectoEstadoChart></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <h3>Top 5 Programadores</h3>
          <div class="chart-container">
            <canvas #proyectoUsuarioChart></canvas>
          </div>
        </div>
        
        <div class="chart-card chart-wide">
          <h3>Distribución de Proyectos</h3>
          <div class="chart-container">
            <canvas #proyectoMensualChart></canvas>
          </div>
        </div>
      </div>

      <!-- LISTADO DETALLADO DE PROYECTOS -->
      <div class="historial-header" *ngIf="proyectos.length > 0">
        <h3>Listado de Proyectos</h3>
        <div class="search-box">
          <input type="text" 
                 placeholder="Buscar por programador, nombre, tipo..."
                 [(ngModel)]="filtroProyectos" 
                 (input)="filtrarProyectos()">
        </div>
      </div>

      <div class="historial-grid" *ngIf="proyectos.length > 0">
        <div *ngFor="let proyecto of proyectosFiltradasHistorial" class="asesoria-item">
          <div class="asesoria-header">
            <span [class]="'estado-badge ' + (proyecto.tipo.toLowerCase() || 'sin-tipo')">
              {{ proyecto.tipo || 'Sin Tipo' }}
            </span>
            <span class="estado-badge" 
                  [class.frontend]="proyecto.participacion === 'Frontend'"
                  [class.backend]="proyecto.participacion === 'Backend'"
                  [class.fullstack]="proyecto.participacion === 'Fullstack'"
                  [class.database]="proyecto.participacion === 'Base de Datos'">
              {{ proyecto.participacion }}
            </span>
          </div>
          
          <div class="asesoria-body">
            <div class="proyecto-info">
              <h4 class="proyecto-titulo">{{ proyecto.nombre }}</h4>
              <p class="proyecto-descripcion" *ngIf="proyecto.descripcion">{{ proyecto.descripcion }}</p>
            </div>

            <div class="participantes">
              <div class="participante">
                <span class="label">Programador:</span>
                <span class="nombre">{{ obtenerNombreUsuario(proyecto.idProgramador) }}</span>
              </div>
            </div>
            
            <div class="tecnologias-proyecto" *ngIf="proyecto.tecnologias && proyecto.tecnologias.length > 0">
              <span class="label">Tecnologías:</span>
              <div class="tech-tags">
                <span *ngFor="let tech of proyecto.tecnologias" class="tech-tag">{{ tech }}</span>
              </div>
            </div>

            <div class="links-proyecto" *ngIf="proyecto.repoUrl || proyecto.demoUrl">
              <a *ngIf="proyecto.repoUrl" 
                 [href]="proyecto.repoUrl" 
                 target="_blank" 
                 class="proyecto-link">
                Repositorio
              </a>
              <a *ngIf="proyecto.demoUrl" 
                 [href]="proyecto.demoUrl" 
                 target="_blank" 
                 class="proyecto-link">
                Ver Demo
              </a>
            </div>
          </div>
        </div>
        
        <div *ngIf="proyectosFiltradasHistorial.length === 0" class="empty-historial">
          <p>No se encontraron proyectos</p>
        </div>
      </div>
    </section>

    <!-- SECCIÓN DE REPORTES -->
    <section class="reports-section">
      <div class="section-header">
        <h2>Reportes Administrativos</h2>
      </div>
      
      <div class="reports-actions">
        <button 
          class="btn btn-report" 
          (click)="descargarReporteAsesoriasPDF()"
          [disabled]="generandoReporte"
          [class.disabled]="generandoReporte">
          {{ generandoReporte ? '⏳ Generando...' : 'Descargar Reporte Asesorías (PDF)' }}
        </button>
        
        <button 
          class="btn btn-report" 
          (click)="descargarReporteProyectosExcel()"
          [disabled]="generandoReporte"
          [class.disabled]="generandoReporte">
          {{ generandoReporte ? '⏳ Generando...' : 'Descargar Reporte Proyectos (Excel)' }}
        </button>
      </div>
    </section>

    <!-- TABLA DE USUARIOS -->
    <section class="users-section" *ngIf="vistaActiva === 'usuarios'">

      <div class="section-header">
        <h2>Gestión de Usuarios</h2>

        <div class="search-box">
          <input type="text" placeholder="Buscar usuarios..." [(ngModel)]="filtro" (input)="filtrarUsuarios()">
        </div>
      </div>

      <div class="table-container">

        <table class="users-table">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let usuario of usuariosFiltrados" [class.highlight]="usuario.uid === usuarioSeleccionado?.uid">

              <td>
                <div class="user-cell">
                  <img [src]="usuario.fotoPerfil || 'https://ui-avatars.com/api/?name=' + usuario.nombre"
                    [alt]="usuario.nombre" [title]="usuario.nombre" class="user-avatar">
                  <span>{{ usuario.nombre }}</span>
                </div>
              </td>

              <td>{{ usuario.email }}</td>

              <td>
                <span class="badge" [ngClass]="usuario.rol">{{ usuario.rol }}</span>
              </td>

              <td>
                <span class="status-badge active">Activo</span>
              </td>

              <td>
                <button class="edit-btn" (click)="editarUsuario(usuario)">✏ Editar</button>
              </td>

            </tr>
          </tbody>
        </table>

        <div *ngIf="usuariosFiltrados.length === 0" class="empty-state">
          ⚠ No se encontraron usuarios
        </div>

      </div>
    </section>

  </main>

  <!-- MODAL EDITAR -->
  <div *ngIf="usuarioSeleccionado" class="modal-overlay" (click)="cancelarEdicion()">
    <div class="modal-content" (click)="$event.stopPropagation()">

      <div class="modal-header">
        <h3>Editar Usuario</h3>
        <button class="close-btn" (click)="cancelarEdicion()">✖</button>
      </div>

      <div class="modal-body">

        <!-- Vista previa -->
        <div class="user-preview">
          <img
            [src]="usuarioSeleccionado.fotoPerfil || 'https://ui-avatars.com/api/?name=' + usuarioSeleccionado.nombre"
            [alt]="'Foto de ' + usuarioSeleccionado.nombre" [title]="usuarioSeleccionado.nombre">
          <div>
            <h4>{{ usuarioSeleccionado.nombre }}</h4>
            <p>{{ usuarioSeleccionado.email }}</p>
          </div>
        </div>

        <!-- Select rol -->
        <div class="form-group">
          <label>Rol de Usuario</label>
          <select [(ngModel)]="usuarioSeleccionado.rol" class="form-control" aria-label="Rol del usuario">
            <option value="usuario">Usuario</option>
            <option value="programador">Programador</option>
            <option value="administrador">Administrador</option>
          </select>
        </div>

        <!-- Campos de programador -->
        <div *ngIf="usuarioSeleccionado.rol === 'programador'">

          <div class="form-group">
            <label>Especialidad</label>
            <input [(ngModel)]="usuarioSeleccionado.especialidad" placeholder="Ej: Fullstack Developer"
              class="form-control">
          </div>

          <div class="form-group">
            <label>Descripción</label>
            <textarea [(ngModel)]="usuarioSeleccionado.descripcion" rows="3" class="form-control" aria-label="Descripción del usuario"></textarea>
          </div>

          <div class="form-group">
            <label>Tecnologías</label>
            <input [ngModel]="usuarioSeleccionado.tecnologias?.join(', ')"
              (ngModelChange)="actualizarTecnologias($event)" placeholder="Angular, React, Node.js..."
              class="form-control">
          </div>

          <div class="form-group" *ngIf="usuarioSeleccionado.disponibilidad">
            <label>Disponibilidad Personalizada por Día</label>
            <p class="help-text">Configura horarios específicos para cada día de la semana</p>

            <div class="disponibilidad-personalizada">
              <div *ngFor="let dia of diasSemana" class="dia-config">
                <div class="dia-header">
                  <label class="checkbox-container">
                    <input type="checkbox" [checked]="esDiaActivo(dia)" (change)="toggleDiaPersonalizado(dia)">
                    <span class="dia-nombre">{{ dia }}</span>
                  </label>
                </div>

                <div class="dia-horarios" *ngIf="esDiaActivo(dia)">
                  <div class="horario-inputs">
                    <div class="input-group">
                      <label>Desde</label>
                      <input type="time" [value]="getHoraInicio(dia)" (change)="setHoraInicio(dia, $event)"
                        class="time-input" [aria-label]="'Hora de inicio para ' + dia">
                    </div>
                    <span class="separator">→</span>
                    <div class="input-group">
                      <label>Hasta</label>
                      <input type="time" [value]="getHoraFin(dia)" (change)="setHoraFin(dia, $event)"
                        class="time-input" [aria-label]="'Hora de fin para ' + dia">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-cancel" (click)="cancelarEdicion()" [disabled]="guardando">Cancelar</button>
        <button 
          class="btn btn-save" 
          (click)="guardarCambios()" 
          [disabled]="guardando"
          [class.disabled]="guardando">
          {{ guardando ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>

    </div>
  </div>

</div>
<div class="programmer-container">
    <header class="programmer-header">
        <h1>Panel de Programador</h1>
        <div class="user-info" *ngIf="usuario">
            <span>Hola, {{ usuario.nombre }}</span>
            <button (click)="cerrarSesion()" class="logout-btn">Cerrar Sesión</button>
        </div>
    </header>

    <nav class="programmer-nav">
        <button [class.active]="seccionActiva === 'proyectos'" (click)="seccionActiva = 'proyectos'">Mis
            Proyectos</button>
        <button [class.active]="seccionActiva === 'perfil'" (click)="seccionActiva = 'perfil'">Mi Perfil</button>
        <button [class.active]="seccionActiva === 'asesorias'" (click)="seccionActiva = 'asesorias'">Asesorías</button>
    </nav>

    <main class="programmer-content">

        <!-- SECCIÓN: MIS PROYECTOS -->
        <section *ngIf="seccionActiva === 'proyectos'" class="projects-section">
            <div class="section-header">
                <h2>Mis Proyectos</h2>
                <button (click)="abrirModalProyecto()" class="add-btn">+ Nuevo Proyecto</button>
            </div>

            <!-- Indicador de carga -->
            <div *ngIf="cargandoProyectos" class="empty-state">
                <div class="spinner"></div>
                <p>Cargando proyectos...</p>
            </div>

            <!-- Grid de proyectos -->
            <div class="projects-grid" *ngIf="!cargandoProyectos">
                <div *ngFor="let proyecto of proyectos" class="project-card">
                    <h3>{{ proyecto.nombre }}</h3>
                    <p class="desc">{{ proyecto.descripcion }}</p>
                    <div class="tags">
                        <span class="tag type">{{ proyecto.tipo }}</span>
                        <span class="tag role">{{ proyecto.participacion }}</span>
                    </div>
                    <div class="techs">
                        <span *ngFor="let tech of proyecto.tecnologias" class="tech-badge">{{ tech }}</span>
                    </div>
                    <div class="actions">
                        <button (click)="editarProyecto(proyecto)" class="edit-btn">Editar</button>
                        <button (click)="eliminarProyecto(proyecto.id!)" class="delete-btn">Eliminar</button>
                    </div>
                </div>
            </div>

            <!-- Estado vacío -->
            <div *ngIf="!cargandoProyectos && proyectos.length === 0" class="empty-state">
                <p>No tienes proyectos registrados aún.</p>
            </div>
        </section>

        <!-- SECCIÓN: MI PERFIL -->
        <section *ngIf="seccionActiva === 'perfil'" class="profile-section">
            <h2>Editar Perfil</h2>
            <div class="profile-card" *ngIf="perfilForm">
                <div class="form-group">
                    <label>Nombre Completo <span class="required">*</span></label>
                    <input [(ngModel)]="perfilForm.nombre" 
                           placeholder="Tu nombre completo"
                           [class.invalid]="perfilFormSubmitted && (!perfilForm.nombre || perfilForm.nombre.trim().length < 3)">
                    <span class="error-message" *ngIf="perfilFormSubmitted && !perfilForm.nombre || (perfilForm.nombre && !perfilForm.nombre.trim())">
                        El nombre es obligatorio
                    </span>
                    <span class="error-message" *ngIf="perfilFormSubmitted && perfilForm.nombre && perfilForm.nombre.trim().length > 0 && perfilForm.nombre.trim().length < 3">
                        El nombre debe tener al menos 3 caracteres
                    </span>
                </div>

                <div class="form-group">
                    <label>Especialidad <span class="required">*</span></label>
                    <input [(ngModel)]="perfilForm.especialidad" 
                           placeholder="Ej: Desarrollador Frontend"
                           [class.invalid]="perfilFormSubmitted && (!perfilForm.especialidad || perfilForm.especialidad.trim().length < 3)">
                    <span class="error-message" *ngIf="perfilFormSubmitted && !perfilForm.especialidad?.trim()">
                        La especialidad es obligatoria
                    </span>
                    <span class="error-message" *ngIf="perfilFormSubmitted && perfilForm.especialidad && perfilForm.especialidad.trim().length > 0 && perfilForm.especialidad.trim().length < 3">
                        La especialidad debe tener al menos 3 caracteres
                    </span>
                </div>

                <div class="form-group">
                    <label>Descripción Profesional</label>
                    <textarea [(ngModel)]="perfilForm.descripcion" 
                              rows="4"
                              placeholder="Cuéntanos sobre ti... (opcional, mínimo 20 caracteres si decides completarla)"
                              [class.invalid]="perfilFormSubmitted && perfilForm.descripcion && perfilForm.descripcion.trim().length > 0 && perfilForm.descripcion.trim().length < 20"></textarea>
                    <span class="error-message" *ngIf="perfilFormSubmitted && perfilForm.descripcion && perfilForm.descripcion.trim().length > 0 && perfilForm.descripcion.trim().length < 20">
                        La descripción debe tener al menos 20 caracteres o dejarse vacía
                    </span>
                </div>

                <div class="form-group">
                    <label>URL Foto de Perfil</label>
                    <input [(ngModel)]="perfilForm.fotoPerfil" 
                           placeholder="https://example.com/foto.jpg">
                    <img *ngIf="perfilForm.fotoPerfil" [src]="perfilForm.fotoPerfil" class="preview-img"
                        alt="Vista previa">
                </div>

                <div class="form-group">
                    <label>Teléfono WhatsApp</label>
                    <input [(ngModel)]="perfilForm.telefono" 
                           placeholder="+593991234567 (incluir código de país)"
                           aria-label="Número de teléfono para WhatsApp">
                    <small class="help-text">Incluye el código de país (ej: +593 para Ecuador) para recibir notificaciones por WhatsApp</small>
                </div>

                <h3>Redes Sociales</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>LinkedIn</label>
                        <input [(ngModel)]="perfilForm.redesSociales!.linkedin" placeholder="URL LinkedIn">
                    </div>
                    <div class="form-group">
                        <label>GitHub</label>
                        <input [(ngModel)]="perfilForm.redesSociales!.github" placeholder="URL GitHub">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Twitter / X</label>
                        <input [(ngModel)]="perfilForm.redesSociales!.twitter" placeholder="URL Twitter">
                    </div>
                    <div class="form-group">
                        <label>Sitio Web Personal</label>
                        <input [(ngModel)]="perfilForm.redesSociales!.sitioWeb" placeholder="URL Sitio Web">
                    </div>
                </div>

                <h3>Disponibilidad para Asesorías</h3>
                
                <div class="disponibilidad-section">
                    <div class="form-group-inline">
                        <label>Modalidad de Atención</label>
                        <select [(ngModel)]="perfilForm.disponibilidad!.modalidad" aria-label="Modalidad de asesorías">
                            <option value="virtual">Virtual</option>
                            <option value="presencial">Presencial</option>
                            <option value="hibrido">Híbrido</option>
                        </select>
                    </div>

                    <div class="horarios-header">
                        <label class="section-label">Horarios Semanales</label>
                        <p class="help-text">Activa los días y configura tus horarios</p>
                    </div>
                    
                    <div class="dias-grid">
                        <div *ngFor="let dia of diasSemana" class="dia-card" [class.activo]="esDiaActivo(dia)">
                            <div class="dia-toggle">
                                <label class="switch">
                                    <input type="checkbox" 
                                           [checked]="esDiaActivo(dia)" 
                                           (change)="toggleDia(dia)"
                                           [attr.aria-label]="'Disponibilidad ' + dia">
                                    <span class="slider"></span>
                                </label>
                                <span class="dia-nombre">{{ dia }}</span>
                            </div>
                            
                            <div class="horario-campos" *ngIf="esDiaActivo(dia)">
                                <div class="tiempo-input">
                                    <label>Desde</label>
                                    <input type="time" 
                                           [value]="getHoraInicio(dia)" 
                                           (change)="setHoraInicio(dia, $event)"
                                           [attr.aria-label]="'Hora inicio ' + dia">
                                </div>
                                <div class="tiempo-input">
                                    <label>Hasta</label>
                                    <input type="time" 
                                           [value]="getHoraFin(dia)" 
                                           (change)="setHoraFin(dia, $event)"
                                           [attr.aria-label]="'Hora fin ' + dia">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-actions">
                    <button 
                        (click)="guardarPerfil()" 
                        class="save-btn"
                        [disabled]="guardandoPerfil"
                        [class.disabled]="guardandoPerfil">
                        {{ guardandoPerfil ? 'Guardando...' : 'Guardar Cambios' }}
                    </button>
                </div>
            </div>
        </section>

        <!-- SECCIÓN: ASESORÍAS -->
        <section *ngIf="seccionActiva === 'asesorias'" class="advisories-section">
            <h2>Solicitudes de Asesoría</h2>

            <!-- Indicador de carga -->
            <div *ngIf="cargandoAsesorias" class="empty-state">
                <div class="spinner"></div>
                <p>Cargando asesorías...</p>
            </div>

            <!-- Lista de asesorías -->
            <div class="advisories-list" *ngIf="!cargandoAsesorias">
                <div *ngFor="let asesoria of asesorias" class="advisory-card"
                    [class.pending]="asesoria.estado === 'pendiente'">
                    <div class="advisory-header">
                        <span class="status-badge" [ngClass]="asesoria.estado">{{ obtenerEstadoFormateado(asesoria.estado) }}</span>
                        <span class="date">{{ obtenerFechaFormateada(asesoria.fechaSolicitud) }}</span>
                    </div>

                    <div class="advisory-body">
                        <h4>Solicitado por: {{ asesoria.nombreUsuario }}</h4>
                        <p><strong>Fecha propuesta:</strong> {{ asesoria.fechaAsesoria }} a las {{ asesoria.horaAsesoria
                            }}</p>
                        <p><strong>Motivo:</strong> {{ asesoria.motivo }}</p>
                        <p><strong>Contacto:</strong> {{ asesoria.emailUsuario }}</p>
                    </div>

                    <div class="advisory-actions" *ngIf="asesoria.estado === 'pendiente'">
                        <button 
                            (click)="responderAsesoria(asesoria, 'aprobada')" 
                            class="accept-btn"
                            [disabled]="respondiendoAsesoria"
                            [class.disabled]="respondiendoAsesoria">
                            {{ respondiendoAsesoria ? 'Procesando...' : 'Aceptar' }}
                        </button>
                        <button 
                            (click)="responderAsesoria(asesoria, 'rechazada')" 
                            class="reject-btn"
                            [disabled]="respondiendoAsesoria"
                            [class.disabled]="respondiendoAsesoria">
                            {{ respondiendoAsesoria ? 'Procesando...' : 'Rechazar' }}
                        </button>
                    </div>

                    <div class="advisory-response" *ngIf="asesoria.estado !== 'pendiente'">
                        <p><strong>Respuesta:</strong> {{ asesoria.mensajeRespuesta || 'Sin mensaje adicional' }}</p>
                    </div>

                    <div class="advisory-cancellation" *ngIf="asesoria.estado === 'cancelada' && asesoria.motivoCancelacion">
                        <p><strong>Motivo de Cancelación:</strong> {{ asesoria.motivoCancelacion }}</p>
                    </div>
                </div>
            </div>

            <!-- Estado vacío -->
            <div *ngIf="!cargandoAsesorias && asesorias.length === 0" class="empty-state">
                <p>No tienes solicitudes de asesoría pendientes.</p>
            </div>
        </section>

    </main>

    <!-- MODAL PROYECTO -->
    <div *ngIf="mostrarModalProyecto" class="modal-overlay">
        <div class="modal-content">
            <h3>{{ proyectoEditando?.id ? 'Editar' : 'Nuevo' }} Proyecto</h3>

            <form [formGroup]="proyectoFormGroup">
                <div class="form-group">
                    <label>Nombre del Proyecto <span class="required">*</span></label>
                    <input formControlName="nombre" placeholder="Ej: E-commerce Angular"
                           [class.invalid]="mostrarErrorCampo('nombre')">
                    <span class="error-message" *ngIf="mostrarErrorCampo('nombre')">
                        {{ obtenerMensajeError('nombre') }}
                    </span>
                </div>

                <div class="form-group">
                    <label>Descripción <span class="required">*</span></label>
                    <textarea formControlName="descripcion" rows="3" 
                              placeholder="Describe tu proyecto (mínimo 10 caracteres)"
                              aria-label="Descripción del proyecto"
                              [class.invalid]="mostrarErrorCampo('descripcion')"></textarea>
                    <span class="error-message" *ngIf="mostrarErrorCampo('descripcion')">
                        {{ obtenerMensajeError('descripcion') }}
                    </span>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo <span class="required">*</span></label>
                        <select formControlName="tipo" aria-label="Tipo de proyecto">
                            <option value="academico">Académico</option>
                            <option value="laboral">Laboral</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Participación <span class="required">*</span></label>
                        <select formControlName="participacion" aria-label="Tipo de participación">
                            <option value="Frontend">Frontend</option>
                            <option value="Backend">Backend</option>
                            <option value="Base de Datos">Base de Datos</option>
                            <option value="Fullstack">Fullstack</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Tecnologías <span class="required">*</span></label>
                    <input formControlName="tecnologias"
                           placeholder="Ej: Angular, Firebase, Node.js (separadas por coma)"
                           [class.invalid]="mostrarErrorCampo('tecnologias')">
                    <span class="error-message" *ngIf="mostrarErrorCampo('tecnologias')">
                        {{ obtenerMensajeError('tecnologias') }}
                    </span>
                </div>

                <div class="form-group">
                    <label>URL Repositorio (GitHub)</label>
                    <input formControlName="repoUrl" 
                           placeholder="https://github.com/usuario/proyecto"
                           aria-label="URL del repositorio"
                           [class.invalid]="mostrarErrorCampo('repoUrl')">
                    <span class="error-message" *ngIf="mostrarErrorCampo('repoUrl')">
                        {{ obtenerMensajeError('repoUrl') }}
                    </span>
                </div>

                <div class="form-group">
                    <label>URL Demo (Despliegue)</label>
                    <input formControlName="demoUrl" 
                           placeholder="https://miproyecto.vercel.app"
                           aria-label="URL de la demo"
                           [class.invalid]="mostrarErrorCampo('demoUrl')">
                    <span class="error-message" *ngIf="mostrarErrorCampo('demoUrl')">
                        {{ obtenerMensajeError('demoUrl') }}
                    </span>
                </div>

                <div class="modal-actions">
                    <button 
                        type="button"
                        (click)="guardarProyecto()" 
                        class="save-btn"
                        [disabled]="guardandoProyecto"
                        [class.disabled]="guardandoProyecto">
                        {{ guardandoProyecto ? 'Guardando...' : 'Guardar' }}
                    </button>
                    <button type="button" (click)="cerrarModalProyecto()" class="cancel-btn" [disabled]="guardandoProyecto">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

</div>